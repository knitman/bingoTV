<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<title>BINGO ÎšÎ¿Ï…Ï€ÏŒÎ½Î¹ Î Î±Î¯ÎºÏ„Î·</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  padding:20px 10px 40px;
  font-family:Arial, sans-serif;
  background:radial-gradient(circle,#ffd000,#ff7a00);
  color:#000;
  text-align:center;
}
#card{
  max-width:420px;
  margin:0 auto;
  background:rgba(255,255,255,0.95);
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
  padding:20px 16px 24px;
}
#title{
  font-size:22px;
  font-weight:bold;
  margin-bottom:8px;
}
#playerName{
  font-size:18px;
  margin-bottom:10px;
}
#ticketIdLabel{
  font-size:13px;
  color:#555;
  margin-bottom:10px;
}
#status{
  font-size:15px;
  margin:12px 0;
}
#numsGrid{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:6px;
  margin-top:10px;
}
.numCell{
  background:#f5f5f5;
  border-radius:8px;
  padding:8px 0;
  font-size:16px;
  font-weight:bold;
  box-shadow:0 2px 4px rgba(0,0,0,0.15);
  cursor:pointer;
}
.numCell.marked{
  background:#4caf50;
  color:#fff;
  box-shadow:0 0 8px rgba(76,175,80,0.9);
}
#buttonsRow{
  margin-top:16px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
}
.btn{
  padding:10px 16px;
  border-radius:20px;
  border:none;
  cursor:pointer;
  font-size:15px;
  font-weight:bold;
  transition:all 0.2s ease;
}
#btnReady{
  background:linear-gradient(135deg,#00c853,#00e676);
  color:#fff;
}
#btnReady.ready-on{
  background:linear-gradient(135deg,#9e9e9e,#bdbdbd);
}
#btnReady:active{transform:scale(0.95);}
#btnBingo{
  background:linear-gradient(135deg,#d50000,#ff1744);
  color:#fff;
}
#btnBingo:active{transform:scale(0.95);}
#btnBingo:disabled{background:#999; cursor:not-allowed;}
#infoText{
  margin-top:10px;
  font-size:13px;
  color:#444;
}
#gameOverBanner{
  margin-top:12px;
  padding:8px;
  background:#ffebee;
  border-radius:10px;
  font-size:14px;
  color:#b71c1c;
  display:none;
}
#topBanner{
  font-size:13px;
  margin-bottom:10px;
  color:#222;
}
@media (max-width:480px){
  #card{padding:18px 12px 22px;}
  .numCell{font-size:14px; padding:6px 0;}
}
</style>
</head>

<body>
<div id="topBanner">BINGO ÎšÎ¿Ï…Ï€ÏŒÎ½Î¹ Î Î±Î¯ÎºÏ„Î·</div>

<div id="card">
  <div id="title">Î¤Î¿ ÎºÎ¿Ï…Ï€ÏŒÎ½Î¹ ÏƒÎ¿Ï…</div>
  <div id="playerName"></div>
  <div id="ticketIdLabel"></div>
  <div id="status">Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹â€¦</div>
  <div id="numsGrid"></div>

  <div id="buttonsRow">
    <button id="btnReady" class="btn" onclick="sendReady()">âœ… Î•Î¯Î¼Î±Î¹ Î­Ï„Î¿Î¹Î¼Î¿Ï‚</button>
    <button id="btnBingo" class="btn" onclick="callBingo()" disabled>ğŸ‰ BINGO!</button>
  </div>

  <div id="infoText">
    Î Î¬Ï„Î·ÏƒÎµ <b>â€œÎ•Î¯Î¼Î±Î¹ Î­Ï„Î¿Î¹Î¼Î¿Ï‚â€</b> ÏŒÏ„Î±Î½ Î­Ï‡ÎµÎ¹Ï‚ Î±Î½Î¿Î¯Î¾ÎµÎ¹ Ï„Î¿ ÎºÎ¿Ï…Ï€ÏŒÎ½Î¹ ÏƒÎ¿Ï….<br>
    ÎŒÏ„Î±Î½ Î¿ Ï€Î±ÏÎ¿Ï…ÏƒÎ¹Î±ÏƒÏ„Î®Ï‚ Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹, Ï„ÏƒÎ­ÎºÎ±ÏÎµ Ï„Î¿Ï…Ï‚ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚ ÏƒÎ¿Ï… ÎºÎ±Î¹ Ï€Î¬Ï„Î± <b>BINGO</b> Î¼ÏŒÎ½Î¿ Î±Î½ ÎµÎ¯ÏƒÎ±Î¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚.
  </div>

  <div id="gameOverBanner"></div>
</div>

<script>
let ticketId = null;
let ticketData = null;
let markedNumbers = [];
let gameOver = false;

/* ===== Helpers ===== */
function getTicketIdFromUrl(){
  const params = new URLSearchParams(location.search);
  return params.get("ticketId");
}

/* ===== WebSocket ===== */
const wsProtocol = location.protocol === "https:" ? "wss://" : "ws://";
const ws = new WebSocket(wsProtocol + location.host);

ws.onmessage = (msg) => {
  const data = JSON.parse(msg.data);

  if(data.type === "gameover"){
    gameOver = true;
    document.getElementById("btnBingo").disabled = true;
    showGameOver("Î¤Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹ Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ.");
  }

  if(data.type === "reset"){
    gameOver = false;
    document.getElementById("btnBingo").disabled = false;
    hideGameOver();
    document.getElementById("status").textContent = "Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹â€¦";
  }

  if(data.type === "bingo" && data.id != ticketId && data.winner){
    gameOver = true;
    document.getElementById("btnBingo").disabled = true;
    showGameOver("Î†Î»Î»Î¿Ï‚ Ï€Î±Î¯ÎºÏ„Î·Ï‚ Î­ÎºÎ±Î½Îµ BINGO!");
  }
};

function showGameOver(msg){
  const g = document.getElementById("gameOverBanner");
  g.textContent = msg;
  g.style.display = "block";
}
function hideGameOver(){
  document.getElementById("gameOverBanner").style.display = "none";
}

/* ===== Load Ticket ===== */
async function loadTicket(){
  ticketId = getTicketIdFromUrl();
  if(!ticketId){ alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ticketId ÏƒÏ„Î¿ URL."); return; }

  const res = await fetch("/api/ticket/" + ticketId);
  if(!res.ok){ alert("Î¤Î¿ ÎºÎ¿Ï…Ï€ÏŒÎ½Î¹ Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ."); return; }

  ticketData = await res.json();
  renderTicket();
}

/* ===== Render Ticket ===== */
function renderTicket(){
  document.getElementById("playerName").textContent = ticketData.name ? ("Î Î±Î¯ÎºÏ„Î·Ï‚: "+ticketData.name) : "Î Î±Î¯ÎºÏ„Î·Ï‚ "+ticketData.id;
  document.getElementById("ticketIdLabel").textContent = "Ticket ID: "+ticketData.id;

  const grid = document.getElementById("numsGrid");
  grid.innerHTML = "";
  markedNumbers = [];

  if(Array.isArray(ticketData.nums)){
    ticketData.nums.forEach(num=>{
      const cell = document.createElement("div");
      cell.className = "numCell";
      cell.textContent = num;
      cell.dataset.num = num;

      cell.addEventListener("click", ()=>{
        toggleMark(num, cell);
      });

      grid.appendChild(cell);
    });
  }
}

/* ===== Mark/Unmark Numbers ===== */
function toggleMark(num, cell){
  if(gameOver) return;

  const idx = markedNumbers.indexOf(num);
  if(idx === -1){
    markedNumbers.push(num);
    cell.classList.add("marked");
  }else{
    markedNumbers.splice(idx,1);
    cell.classList.remove("marked");
  }

  const btnBingo = document.getElementById("btnBingo");
  btnBingo.disabled = markedNumbers.length !== ticketData.nums.length;

  if(markedNumbers.length > 0){
    document.getElementById("status").textContent = "ÎˆÏ‡ÎµÎ¹Ï‚ Î¼Î±ÏÎºÎ¬ÏÎµÎ¹ "+markedNumbers.length+" Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚.";
  }else{
    document.getElementById("status").textContent = "Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹â€¦";
  }
}

/* ===== READY BUTTON ===== */
let hasSentReady = false;
async function sendReady(){
  if(hasSentReady || !ticketId) return;

  const btn = document.getElementById("btnReady");

  try{
    const res = await fetch("/api/ready/" + ticketId, { method:"POST" });
    if(!res.ok){ alert("Î ÏÏŒÎ²Î»Î·Î¼Î± Î¼Îµ Ï„Î·Î½ Î´Î®Î»Ï‰ÏƒÎ· ÎµÏ„Î¿Î¹Î¼ÏŒÏ„Î·Ï„Î±Ï‚."); return; }

    const data = await res.json();
    hasSentReady = true;
    btn.classList.add("ready-on");
    btn.textContent = "âœ… Î”Î®Î»Ï‰ÏƒÎµÏ‚ ÏŒÏ„Î¹ ÎµÎ¯ÏƒÎ±Î¹ Î­Ï„Î¿Î¹Î¼Î¿Ï‚";
    btn.disabled = true;

    document.getElementById("status").textContent = data.allReady ? "ÎŒÎ»Î¿Î¹ Î¿Î¹ Ï€Î±Î¯ÎºÏ„ÎµÏ‚ ÎµÎ¯Î½Î±Î¹ Î­Ï„Î¿Î¹Î¼Î¿Î¹! Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµâ€¦" : "Î ÎµÏÎ¯Î¼ÎµÎ½Îµ Ï„Î¿Ï…Ï‚ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Ï…Ï‚ Ï€Î±Î¯ÎºÏ„ÎµÏ‚â€¦";

  }catch(e){ alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î·Î½ ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± Î¼Îµ Ï„Î¿Î½ server."); }
}

/* ===== BINGO BUTTON ===== */
async function callBingo(){
  if(!ticketId || gameOver) return;
  if(!confirm("Î•Î¯ÏƒÎ±Î¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î­Ï‡ÎµÎ¹Ï‚ BINGO;")) return;

  try{
    const res = await fetch("/api/bingo/" + ticketId, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ marked: markedNumbers })
    });
    const data = await res.json();

    if(data.winner){
      gameOver = true;
      document.getElementById("btnBingo").disabled = true;
      showGameOver("Î£Ï…Î³Ï‡Î±ÏÎ·Ï„Î®ÏÎ¹Î±! ÎˆÎºÎ±Î½ÎµÏ‚ BINGO!");
    }else{
      alert("Î¤Î¿ BINGO Ï€Î¿Ï… Î´Î®Î»Ï‰ÏƒÎµÏ‚ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ¿.");
    }
  }catch(e){ alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î·Î½ ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î± Î¼Îµ Ï„Î¿Î½ server."); }
}

/* ===== Init ===== */
loadTicket();
</script>
</body>
</html>
