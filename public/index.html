<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<title>BINGO TV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js">
/* ===== INIT FULL DRAWN GRID ===== */
function initDrawnGrid(){
  const d = document.getElementById("drawn");
  d.innerHTML = "";
  for(let i=1;i<=75;i++){
    const b=document.createElement("div");
    b.className="ball";
    b.dataset.num=i;
    b.innerText=i;
    d.appendChild(b);
  }
}
/* ===== END INIT FULL DRAWN GRID ===== */

</script>

<style>
body{
  background:radial-gradient(circle,#ffd000,#ff7a00);
  font-family:Arial, sans-serif;
  text-align:center;
  color:#000;
  margin:0;
  padding:0 0 40px;
}

/* Î¤Î¯Ï„Î»Î¿Ï‚ */
h1{
  margin-top:15px;
}

/* ÎœÎµÎ³Î¬Î»Î· Î¼Ï€Î¬Î»Î± 4K */
#number{
  width:400px;
  height:400px;
  border-radius:50%;
  background:white;
  font-size:200px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:20px auto;
  transition: transform 0.3s ease;
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
}

/* Zoom animation */
#number.zoom {
  transform: scale(1.25);
}

/* Glass panel controls */
.controls {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 20px;
  margin: 15px auto;
  padding: 20px 30px;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(12px);
  border-radius: 30px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.25);
}

/* Premium curved buttons */
.controls button {
  padding: 14px 28px;
  font-size: 22px;
  margin: 8px;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  font-weight: bold;
  color: white;
  transition: all 0.25s ease;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
  overflow: hidden;
}

/* Disabled state */
.controls button:disabled {
  background: #777 !important;
  box-shadow: none;
  cursor: not-allowed;
  transform: none !important;
}

/* Ripple effect */
.controls button::after {
  content:"";
  position:absolute;
  width:0;
  height:0;
  background:rgba(255,255,255,0.5);
  border-radius:50%;
  transform:translate(-50%, -50%);
  top:var(--y);
  left:var(--x);
  transition:width 0.4s ease, height 0.4s ease;
}
.controls button:active::after {
  width:200px;
  height:200px;
}

/* Press animation */
.controls button:active {
  transform: scale(0.92);
}

/* AUTO = Ï€ÏÎ¬ÏƒÎ¹Î½Î¿ */
#btnAuto {
  background: linear-gradient(135deg, #00c853, #00e676);
}
#btnAuto:hover:not(:disabled) {
  transform: scale(1.08);
  box-shadow: 0 8px 22px rgba(0,200,83,0.6);
}

/* STOP = ÎºÏŒÎºÎºÎ¹Î½Î¿ */
#btnStop {
  background: linear-gradient(135deg, #d50000, #ff1744);
}
#btnStop:hover:not(:disabled) {
  transform: scale(1.08);
  box-shadow: 0 8px 22px rgba(213,0,0,0.6);
}

/* RESET = Î¼Ï€Î»Îµ */
#btnReset {
  background: linear-gradient(135deg, #2962ff, #448aff);
}
#btnReset:hover:not(:disabled) {
  transform: scale(1.08);
  box-shadow: 0 8px 22px rgba(41,98,255,0.6);
}

/* Drawn numbers grid */
#drawn{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:10px;
}

/* ÎœÎ¹ÎºÏÎ­Ï‚ Î¼Ï€Î¬Î»ÎµÏ‚ 4K */
.ball{
  width:90px;
  height:90px;
  border-radius:50%;
  background:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:32px;
  box-shadow:0 5px 15px rgba(0,0,0,0.2);
}

/* Î‰Ï‡Î¿Î¹ */
audio { display:none; }

/* Î Î¯Î½Î±ÎºÎ±Ï‚ Ï€Î±Î¹ÎºÏ„ÏÎ½ */
#playersContainer{
  max-width:1000px;
  margin:20px auto;
  text-align:left;
  background:rgba(255,255,255,0.9);
  padding:15px 20px 20px;
  border-radius:12px;
  box-shadow:0 5px 20px rgba(0,0,0,0.2);
}
#playersContainer h2{
  margin-top:0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:22px;
}
#playersInfo{
  font-size:14px;
  color:#555;
}
#playersTable{
  width:100%;
  border-collapse:collapse;
  font-size:16px;
}
#playersTable th, #playersTable td{
  padding:6px 8px;
  border-bottom:1px solid #ccc;
}
#playersTable th{
  background:#f0f0f0;
}
.winnerRow{
  background:#c8e6c9;
  font-weight:bold;
}
.almostRow {
  position: relative;
  animation: pulseRow 1s infinite;
  background: #fff8e1;
}
@keyframes pulseRow {
  0% { box-shadow: 0 0 0 rgba(255,215,0,0.0); }
  50% { box-shadow: 0 0 20px rgba(255,215,0,0.9); }
  100% { box-shadow: 0 0 0 rgba(255,215,0,0.0); }
}
.almostRow::before,
.almostRow::after {
  content: "âœ¨";
  position:absolute;
  top:-10px;
  font-size:18px;
}
.almostRow::before { left:-10px; }
.almostRow::after  { right:-10px; }

/* Progress bar */
.progOuter {
  width:100%;
  height:12px;
  background:#ddd;
  border-radius:6px;
  overflow:hidden;
}
.progInner {
  height:100%;
  width:0%;
  background:#4caf50;
  transition:width 0.3s ease, background 0.3s ease;
}
.progInner.near {
  background:#ff5252;
}

/* Ready badge */
.readyBadge {
  display:inline-block;
  padding:2px 6px;
  border-radius:10px;
  font-size:12px;
  color:#fff;
  background:#9e9e9e;
}
.readyBadge.on {
  background:#00c853;
}

/* ===== COUNTDOWN OVERLAY ===== */

#countdownOverlay {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  display:none;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}
#countdownInner{
  position:relative;
  width:260px;
  height:260px;
}
#countdownCircle {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  border-radius:50%;
  border:10px solid rgba(0,0,0,0.25);
  box-shadow:0 0 25px rgba(0,0,0,0.5);
  display:flex;
  align-items:center;
  justify-content:center;
}
#countdownFill {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  border-radius:50%;
  background:conic-gradient(#ff6f00 0deg, #ffea00 120deg, transparent 120deg);
  transform-origin:center;
  transform:rotate(0deg) scale(1);
  opacity:0.85;
}
#countdownNumber {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:120px;
  font-weight:bold;
  color:#ffffff;
  text-shadow:0 0 20px rgba(0,0,0,0.9);
}

/* ===== QR PANEL (COLLAPSIBLE) ===== */

#qrPanelContainer{
  max-width:1000px;
  margin:20px auto;
  text-align:left;
  background:rgba(255,255,255,0.9);
  padding:12px 18px 18px;
  border-radius:12px;
  box-shadow:0 5px 20px rgba(0,0,0,0.2);
}

#qrPanelHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}

#qrPanelTitle{
  font-size:20px;
  font-weight:bold;
}

#qrToggleIcon{
  font-size:20px;
}

#qrPanelBody{
  margin-top:10px;
  display:none;
}

#namesInput{
  width:100%;
  min-height:90px;
  resize:vertical;
  padding:8px;
  font-size:14px;
}

#qrActions{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

#qrInfo{
  font-size:13px;
  color:#555;
}

/* simple styled button inside QR panel */
.qrBtn{
  padding:8px 16px;
  border:none;
  border-radius:18px;
  background:#2962ff;
  color:#fff;
  cursor:pointer;
  font-size:14px;
  font-weight:bold;
}
.qrBtn:hover{
  background:#0039cb;
}

/* QR Grid */
#qrGrid{
  margin-top:12px;
  display:grid;
  grid-template-columns:repeat(5, 1fr);
  gap:10px;
}
.qrItem{
  background:#f5f5f5;
  border-radius:10px;
  padding:6px;
  text-align:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}
.qrName{
  font-size:14px;
  font-weight:bold;
  margin-bottom:4px;
}
.qrCanvasWrapper{
  background:white;
  border-radius:6px;
  padding:4px;
}

/* Responsive tweaks */
@media (max-width:1200px){
  #number{
    width:280px;
    height:280px;
    font-size:130px;
  }
  .ball{
    width:70px;
    height:70px;
    font-size:26px;
  }
}
@media (max-width:800px){
  #qrGrid{
    grid-template-columns:repeat(3,1fr);
  }
}
@media (max-width:600px){
  #qrGrid{
    grid-template-columns:repeat(2,1fr);
  }
  .controls button{
    font-size:18px;
    padding:10px 20px;
  }
}

/* ===== DRAWN GRID FULL (1â€“75 PREPOPULATED) ===== */
#drawn .ball {
  color: rgba(255,255,255,0.35);
  background: rgba(255,255,255,0.25);
}

#drawn .ball.drawn {
  color: #000;
  background: #ff1744;
}
/* ===== END DRAWN GRID FULL ===== */

</style>
</head>

<body>

<h1>BINGO ÎšÎ›Î—Î¡Î©Î£Î—</h1>

<div style="margin:20px;">
  <button onclick="newGame()" 
          style="padding:12px 24px;font-size:20px;border:none;border-radius:12px;
                 background:#ff1744;color:white;font-weight:bold;cursor:pointer;">
    ğŸ†• ÎÎ­Î¿ Î Î±Î¹Ï‡Î½Î¯Î´Î¹
  </button>
</div>

<div id="number">â€“</div>

<!-- Î‰Ï‡Î¿Î¹ -->
<audio id="soundNumber" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
<audio id="soundNear"   src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
<audio id="soundBingo"  src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<!-- Cinematic countdown (placeholder mp3/ogg link â€“ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï„Î¿ Î±Î»Î»Î¬Î¾ÎµÎ¹Ï‚ ÏƒÎµ Î´Î¹ÎºÏŒ ÏƒÎ¿Ï…) -->
<audio id="soundCountdown" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<div class="controls">
  <button id="btnAuto" onclick="startAuto()">â–¶ï¸ AUTO</button>
  <button id="btnStop" onclick="stopAuto()">â¹ï¸ STOP</button>
  <button id="btnReset" onclick="resetGame()">ğŸ”„ RESET</button>
</div>

<div id="drawn"></div>

<div id="playersContainer">
  <h2>
    Î ÏÏŒÎ¿Î´Î¿Ï‚ Ï€Î±Î¹ÎºÏ„ÏÎ½
    <span id="playersInfo"></span>
  </h2>
  <table id="playersTable">
    <thead>
      <tr>
        <th>Î Î±Î¯ÎºÏ„Î·Ï‚</th>
        <th>Î•Ï€Î¹Ï„Ï…Ï‡Î¯ÎµÏ‚</th>
        <th>Î ÏÏŒÎ¿Î´Î¿Ï‚</th>
        <th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
        <th>Ready</th>
      </tr>
    </thead>
    <tbody id="playersBody"></tbody>
  </table>
</div>

<div id="qrPanelContainer">
  <div id="qrPanelHeader" onclick="toggleQrPanel()">
    <div id="qrPanelTitle">ğŸ« ÎœÎ±Î¶Î¹ÎºÎ® Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ¿Ï…Ï€Î¿Î½Î¹ÏÎ½ (QR)</div>
    <div id="qrToggleIcon">â–¸</div>
  </div>
  <div id="qrPanelBody">
    <p style="font-size:14px;margin:8px 0 4px;">
      Î“ÏÎ¬ÏˆÎµ Î­Î½Î± ÏŒÎ½Î¿Î¼Î± Î±Î½Î¬ Î³ÏÎ±Î¼Î¼Î®:
    </p>
    <textarea id="namesInput" placeholder="Ï€.Ï‡.&#10;Î“Î¹ÏÏÎ³Î¿Ï‚&#10;ÎœÎ±ÏÎ¯Î±&#10;ÎÎ¯ÎºÎ¿Ï‚"></textarea>
    <div id="qrActions">
      <button class="qrBtn" onclick="createBulkTickets()">Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ ÏŒÎ»Î± Ï„Î± ÎºÎ¿Ï…Ï€ÏŒÎ½Î¹Î±</button>
      <span id="qrInfo"></span>
    </div>
    <div id="qrGrid"></div>
  </div>
</div>

<!-- Countdown overlay -->
<div id="countdownOverlay">
  <div id="countdownInner">
    <div id="countdownCircle"></div>
    <div id="countdownFill"></div>
    <div id="countdownNumber"></div>
  </div>
</div>

<script>
let auto = null;
initDrawnGrid();
let gameOver = false;
let lastNearIds = new Set();
let expectedPlayersCount = 0;
let countdownTimer = null;
let countdownValue = 0;
let isCountingDown = false;

/* Ripple effect */
document.querySelectorAll(".controls button").forEach(btn => {
  btn.addEventListener("click", e => {
    const rect = btn.getBoundingClientRect();
    btn.style.setProperty("--x", e.clientX - rect.left + "px");
    btn.style.setProperty("--y", e.clientY - rect.top + "px");
  });
});

/* ===== WebSocket ===== */
const wsProtocol = location.protocol === "https:" ? "wss://" : "ws://";
const ws = new WebSocket(wsProtocol + location.host);

ws.onmessage = (msg) => {
  const data = JSON.parse(msg.data);

  if (data.type === "state") {
    gameOver = !!data.gameOver;
    expectedPlayersCount = data.expectedPlayersCount || 0;
    updateControls();
    if (data.drawn?.length > 0) {
      const last = data.drawn[data.drawn.length - 1];
      show(last, data.drawn);
    }
    if (data.type === "newgame") {
  numbersCleared();
  renderPlayers([]);
  stopAuto();
  stopCountdown(true);

  document.getElementById("qrGrid").innerHTML = "";
  document.getElementById("namesInput").value = "";
  document.getElementById("qrInfo").textContent = "";

  expectedPlayersCount = 0;
}
    if (data.players) renderPlayers(data.players);
  }

  if (data.type === "number") {
    if (!gameOver) {
      show(data.number, data.drawn);
    }
    if (data.players) renderPlayers(data.players);
  }

  if (data.type === "players") {
    if (data.players) renderPlayers(data.players);
  }

  if (data.type === "bingo") {
    if (data.winner) {
      gameOver = true;
      updateControls();
      stopAuto();
      document.getElementById("soundBingo").play();
      alert("ğŸ† " + data.name + " Î­ÎºÎ±Î½Îµ BINGO! Î¤Î­Î»Î¿Ï‚ Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï.");
    } else {
      alert("âŒ " + data.name + " Î´Î®Î»Ï‰ÏƒÎµ BINGO Î±Î»Î»Î¬ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ¿.");
    }
  }

  if (data.type === "gameover") {
    gameOver = true;
    updateControls();
    stopAuto();
  }

  if (data.type === "reset") {
    gameOver = false;
    numbersCleared();
    renderPlayers([]);
    stopCountdown(true);
  }

  if (data.type === "all_ready") {
    // ÎŒÎ»Î¿Î¹ Î¿Î¹ Ï€Î±Î¯ÎºÏ„ÎµÏ‚ Î±Ï€ÏŒ Ï„Î¿ bulk ÎµÎ¯Î½Î±Î¹ ready -> Î¾ÎµÎºÎ¯Î½Î± Î±Î½Ï„Î¯ÏƒÏ„ÏÎ¿Ï†Î· Î¼Î­Ï„ÏÎ·ÏƒÎ·
    if (!isCountingDown && !gameOver) {
      startCountdown(30);
    }
  }
};

function numbersCleared(){
  initDrawnGrid();

  document.getElementById("drawn").innerHTML = "";
  document.getElementById("number").innerText = "â€“";
}

/* ===== Controls state ===== */
function updateControls() {
  const autoBtn = document.getElementById("btnAuto");
  const stopBtn = document.getElementById("btnStop");
  const resetBtn = document.getElementById("btnReset");

  if (gameOver) {
    autoBtn.disabled = true;
    stopBtn.disabled = true;
  } else {
    // Î‘Î½ ÎºÎ¬Î½Î¿Ï…Î¼Îµ countdown, Î´ÎµÎ½ ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ manual start
    autoBtn.disabled = isCountingDown;
    stopBtn.disabled = false;
  }
  resetBtn.disabled = false;
}

/* ===== AUTO DRAW ===== */
async function autoDraw(){
  if (gameOver) {
    stopAuto();
    return;
  }
  await fetch("/api/draw");
}

async function startAuto(){
  if (gameOver || isCountingDown) return;

  // Î‘Î½ Î­Ï‡Î¿Ï…Î¼Îµ expectedPlayersCount > 0, Î¿ server Î¸Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ Î¾Î±Î½Î¬
  const res = await fetch("/api/start", { method: "POST" });
  const data = await res.json();

  if (data.ok) {
    if (auto) clearInterval(auto);
    auto = setInterval(autoDraw, 5000);
  } else if (data.reason === "not_all_ready") {
    alert("Î”ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÏŒÎ»Î¿Î¹ Î¿Î¹ Ï€Î±Î¯ÎºÏ„ÎµÏ‚ Î­Ï„Î¿Î¹Î¼Î¿Î¹ Î±ÎºÏŒÎ¼Î·.");
  }
}

function stopAuto(){
  fetch("/api/stop", { method: "POST" });
  if (auto) {
    clearInterval(auto);
    auto = null;
  }
}
async function newGame(){
  if (!confirm("Î˜Î­Î»ÎµÎ¹Ï‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ ÎÎ•ÎŸ Î Î‘Î™Î§ÎÎ™Î”Î™; ÎŒÎ»Î± Î¸Î± Ï‡Î±Î¸Î¿ÏÎ½.")) return;

  const res = await fetch("/api/newgame", { method: "POST" });
  const data = await res.json();

  if (data.ok) {
    numbersCleared();
    renderPlayers([]);
    stopAuto();
    stopCountdown(true);

    document.getElementById("qrGrid").innerHTML = "";
    document.getElementById("namesInput").value = "";
    document.getElementById("qrInfo").textContent = "";

    expectedPlayersCount = 0;

    alert("ÎÎµÎºÎ¯Î½Î·ÏƒÎµ Î½Î­Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹!");
  }
}
/* ===== RESET ===== */
function resetGame(){
  fetch("/api/reset", { method: "POST" });
}

/* ===== UPDATE MAIN NUMBER + DRAWN LIST ===== */
function show(n, arr){
  const num = document.getElementById("number");
  num.innerText = n;

  num.classList.add("zoom");
  setTimeout(() => num.classList.remove("zoom"), 300);

  document.getElementById("soundNumber").play();

  const d=document.getElementById("drawn");
  const el=d.querySelector('.ball[data-num="'+n+'"]');
  if(el) el.classList.add('drawn');
  arr.forEach(x=>{
    const b=document.createElement("div");
    b.className="ball"; 
    b.innerText=x;
    d.appendChild(b);
  });
}

/* ===== PLAYERS TABLE + NEAR-BINGO + READY ===== */
function renderPlayers(players){
  const tbody = document.getElementById("playersBody");
  tbody.innerHTML = "";

  const info = document.getElementById("playersInfo");
  const total = players.length;
  const readyCount = players.filter(p => p.ready).length;
  info.textContent = `Î£ÏÎ½Î¿Î»Î¿: ${total} | ÎˆÏ„Î¿Î¹Î¼Î¿Î¹: ${readyCount}${expectedPlayersCount ? " / " + expectedPlayersCount : ""}`;

  const newNearIds = new Set();
  const NEAR_THRESHOLD = 80;

  players.forEach(p => {
    const tr = document.createElement("tr");

    if (p.winner) {
      tr.classList.add("winnerRow");
    } else if (p.progress >= NEAR_THRESHOLD) {
      tr.classList.add("almostRow");
      newNearIds.add(p.id);
    }

    const tdName = document.createElement("td");
    tdName.textContent = p.name;

    const tdHits = document.createElement("td");
    tdHits.textContent = `${p.hits}/${p.total}`;

    const tdProg = document.createElement("td");
    const progOuter = document.createElement("div");
    progOuter.className = "progOuter";
    const progInner = document.createElement("div");
    progInner.className = "progInner";
    progInner.style.width = p.progress + "%";
    if (p.progress >= NEAR_THRESHOLD && !p.winner) {
      progInner.classList.add("near");
    }
    progOuter.appendChild(progInner);
    tdProg.appendChild(progOuter);

    const tdStatus = document.createElement("td");
    tdStatus.textContent = p.winner ? "Bingo!" : "Î Î±Î¯Î¶ÎµÎ¹";

    const tdReady = document.createElement("td");
    const span = document.createElement("span");
    span.className = "readyBadge" + (p.ready ? " on" : "");
    span.textContent = p.ready ? "ÎˆÏ„Î¿Î¹Î¼Î¿Ï‚" : "ÎŒÏ‡Î¹";
    tdReady.appendChild(span);

    tr.appendChild(tdName);
    tr.appendChild(tdHits);
    tr.appendChild(tdProg);
    tr.appendChild(tdStatus);
    tr.appendChild(tdReady);

    tbody.appendChild(tr);
  });

  let playNearSound = false;
  newNearIds.forEach(id => {
    if (!lastNearIds.has(id)) playNearSound = true;
  });
  if (playNearSound && newNearIds.size > 0) {
    document.getElementById("soundNear").play();
  }

  lastNearIds = newNearIds;
}

/* ===== QR PANEL (COLLAPSIBLE + BULK TICKETS) ===== */

let qrPanelOpen = false;

function toggleQrPanel(){
  qrPanelOpen = !qrPanelOpen;
  const body = document.getElementById("qrPanelBody");
  const icon = document.getElementById("qrToggleIcon");
  if (qrPanelOpen) {
    body.style.display = "block";
    icon.textContent = "â–¾";
  } else {
    body.style.display = "none";
    icon.textContent = "â–¸";
  }
}

async function createBulkTickets(){
  const text = document.getElementById("namesInput").value || "";
  const lines = text
    .split("\n")
    .map(x => x.trim())
    .filter(x => x.length > 0);

  if (lines.length === 0) {
    alert("Î’Î¬Î»Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î± ÏŒÎ½Î¿Î¼Î±.");
    return;
  }

  const res = await fetch("/api/tickets/bulk", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ names: lines })
  });

  if (!res.ok) {
    alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î¿ bulk Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ¿Ï…Ï€Î¿Î½Î¹ÏÎ½.");
    return;
  }

  const data = await res.json();
  expectedPlayersCount = data.length;
  document.getElementById("qrInfo").textContent =
    "Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎ±Î½ " + data.length + " ÎºÎ¿Ï…Ï€ÏŒÎ½Î¹Î±.";

  renderQrGrid(data);
}

/* Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ QR grid (5 Î±Î½Î¬ ÏƒÎµÎ¹ÏÎ¬) */
function renderQrGrid(data){
  const container = document.getElementById("qrGrid");
  container.innerHTML = "";

  data.forEach(item => {
    const div = document.createElement("div");
    div.className = "qrItem";

    const nameDiv = document.createElement("div");
    nameDiv.className = "qrName";
    nameDiv.textContent = item.name;

    const canvasWrapper = document.createElement("div");
    canvasWrapper.className = "qrCanvasWrapper";
    const canvas = document.createElement("canvas");

    const link = location.origin + "/ticket.html?ticketId=" + item.ticketId;

    QRCode.toCanvas(canvas, link, { width: 120 }, (err) => {
      if (err) console.error(err);
    });

    canvasWrapper.appendChild(canvas);
    div.appendChild(nameDiv);
    div.appendChild(canvasWrapper);
    container.appendChild(div);
  });
}

/* ===== COUNTDOWN (30 -> 0) ===== */

function startCountdown(seconds){
  if (isCountingDown) return;
  isCountingDown = true;
  countdownValue = seconds;

  const overlay = document.getElementById("countdownOverlay");
  const num = document.getElementById("countdownNumber");
  const fill = document.getElementById("countdownFill");
  const soundCountdown = document.getElementById("soundCountdown");

  overlay.style.display = "flex";

  function update(){
    num.textContent = countdownValue;
    const angle = (countdownValue / seconds) * 360;
    fill.style.transform = "rotate(" + (360 - angle) + "deg) scale(1)";
    fill.style.opacity = 0.9;

    // Play cinematic beep each second
    try { soundCountdown.currentTime = 0; soundCountdown.play(); } catch(e){}

    countdownValue--;

    if (countdownValue < 0) {
      stopCountdown(false);
      // BOOM effect
      fill.style.transform = "scale(1.3)";
      fill.style.opacity = 0;
      setTimeout(() => {
        overlay.style.display = "none";
        // ÎÎµÎºÎ¹Î½Î¬ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹
        startAuto();
      }, 300);
    } else {
      countdownTimer = setTimeout(update, 1000);
    }
  }

  update();
}

function stopCountdown(forceHide){
  isCountingDown = false;
  if (countdownTimer) {
    clearTimeout(countdownTimer);
    countdownTimer = null;
  }
  if (forceHide) {
    document.getElementById("countdownOverlay").style.display = "none";
  }
  updateControls();
}

/* ===== INIT FULL DRAWN GRID ===== */
function initDrawnGrid(){
  const d = document.getElementById("drawn");
  d.innerHTML = "";
  for(let i=1;i<=75;i++){
    const b=document.createElement("div");
    b.className="ball";
    b.dataset.num=i;
    b.innerText=i;
    d.appendChild(b);
  }
}
/* ===== END INIT FULL DRAWN GRID ===== */

</script>

</body>

</html>

